/*! j-toker - v0.0.10-beta3 - 2023-03-10
* Copyright (c) 2023 Lynn Dylan Hurley; Licensed WTFPL */
!function(e){"function"==typeof define&&define.amd?define(["jquery","deparam","pubsub-js","jquery.cookie"],e):"object"==typeof exports?module.exports=e(require("jquery"),require("deparam"),require("pubsub-js"),require("jquery.cookie")):e(window.jQuery,window.deparam,window.PubSub)}(function(e,t,r){var a=Function("return this")();if(a.auth)return a.auth;var s=a.navigator,c="default",o="currentConfigName",n="authHeaders",l="firstTimeLogin",m="mustResetPassword",u="auth.validation.success",i="auth.validation.error",p="auth.oAuthSignIn.error",R="auth.signIn.success",d="auth.signIn.error",E=function(){this.configured=!1,this.configDfd=null,this.configs={},this.defaultConfigKey=null,this.firstTimeLogin=!1,this.mustResetPassword=!1,this.user={},this.oAuthDfd=null,this.oAuthTimer=null,this.configBase={apiUrl:"/api",signOutPath:"/auth/sign_out",emailSignInPath:"/auth/sign_in",emailRegistrationPath:"/auth",accountUpdatePath:"/auth",accountDeletePath:"/auth",passwordResetPath:"/auth/password",passwordUpdatePath:"/auth/password",tokenValidationPath:"/auth/validate_token",proxyIf:function(){return!1},proxyUrl:"/proxy",forceHardRedirect:!1,storage:"cookies",cookieExpiry:14,cookiePath:"/",initialCredentials:null,passwordResetSuccessUrl:function(){return a.location.href},confirmationSuccessUrl:function(){return a.location.href},tokenFormat:{"access-token":"{{ access-token }}","token-type":"Bearer",client:"{{ client }}",expiry:"{{ expiry }}",uid:"{{ uid }}"},parseExpiry:function(e){return 1e3*parseInt(e.expiry,10)||null},handleLoginResponse:function(e){return e.data},handleAccountUpdateResponse:function(e){return e.data},handleTokenValidationResponse:function(e){return e.data},authProviderPaths:{github:"/auth/github",facebook:"/auth/facebook",google:"/auth/google_oauth2"}}};E.prototype.reset=function(){this.destroySession(),this.configs={},this.defaultConfigKey=null,this.configured=!1,this.configDfd=null,this.mustResetPassword=!1,this.firstTimeLogin=!1,this.oAuthDfd=null,this.willRedirect=!1,this.oAuthTimer&&(clearTimeout(this.oAuthTimer),this.oAuthTimer=null);for(var t in this.user)delete this.user[t];e(document).unbind("ajaxComplete",this.updateAuthCredentials),a.removeEventListener&&a.removeEventListener("message",this.handlePostMessage),e.ajaxSetup({beforeSend:void 0})},E.prototype.invalidateTokens=function(){for(var e in this.user)delete this.user[e];this.deleteData(o),this.deleteData(n)},E.prototype.checkDependencies=function(){var s=[],c=[];if(!e)throw"jToker: jQuery not found. This module depends on jQuery.";if(a.localStorage||e.cookie||s.push("This browser does not support localStorage. You must install jquery-cookie to use jToker with this browser."),t||s.push("Dependency not met: deparam."),r||c.push("jquery.ba-tinypubsub.js not found. No auth events will be broadcast."),s.length)throw"jToker: Please resolve the following errors: "+s.join(" ");if(c.length&&console&&console.warn){var o=c.join(" ");console.warn("jToker: Warning: "+o)}},E.prototype.destroySession=function(){var t=[n,o];for(var r in t)if(r=t[r],a.localStorage&&a.localStorage.removeItem(r),e.cookie){for(var s in this.configs){var c=this.configs[s].cookiePath;e.removeCookie(r,{path:c})}e.removeCookie(r,{path:"/"})}},E.prototype.configure=function(t,r){if(r&&this.reset(),this.configured)return this.configDfd;if(this.configured=!0,t||(t={}),t.constructor!==Array){this.defaultConfigKey=c;var s={};s[this.defaultConfigKey]=t,t=[s]}for(var o=0;o<t.length;o++){var u=h(t[o]);this.defaultConfigKey||(this.defaultConfigKey=u),this.configs[u]=e.extend({},this.configBase,t[o][u])}if(this.checkDependencies(),e(document).ajaxComplete(a.auth.updateAuthCredentials),e.ajaxSetup({beforeSend:a.auth.appendAuthHeaders}),a.addEventListener&&a.addEventListener("message",this.handlePostMessage,!1),this.processSearchParams(),this.willRedirect)return!1;if(this.getConfig().initialCredentials){var i=this.getConfig();return this.persistData(n,i.initialCredentials.headers),this.persistData(m,i.initialCredentials.mustResetPassword),this.persistData(l,i.initialCredentials.firstTimeLogin),this.setCurrentUser(i.initialCredentials.user),(new e.Deferred).resolve(i.initialCredentials.user)}return this.configDfd=this.validateToken({config:this.getCurrentConfigName()}),this.configDfd},E.prototype.getApiUrl=function(){var e=this.getConfig();return e.proxyIf()?e.proxyUrl:e.apiUrl},E.prototype.buildAuthHeaders=function(e){var t={},r=this.getConfig().tokenFormat;for(var a in r)t[a]=f(r[a],e);return t},E.prototype.setCurrentUser=function(t){for(var r in this.user)delete this.user[r];return e.extend(this.user,t),this.user.signedIn=!0,this.user.configName=this.getCurrentConfigName(),this.user},E.prototype.handlePostMessage=function(e){var t=!1;if("deliverCredentials"===e.data.message){delete e.data.message;var r=a.auth.normalizeTokenKeys(e.data),s=a.auth.buildAuthHeaders(r),c=a.auth.setCurrentUser(e.data);a.auth.persistData(n,s),a.auth.resolvePromise("auth.oAuthSignIn.success",a.auth.oAuthDfd,c),a.auth.broadcastEvent(R,c),a.auth.broadcastEvent(u,c),t=!0}"authFailure"===e.data.message&&(a.auth.rejectPromise(p,a.auth.oAuthDfd,e.data,"OAuth authentication failed."),a.auth.broadcastEvent(d,e.data),t=!0),t&&(clearTimeout(a.auth.oAuthTimer),a.auth.oAuthTimer=null)},E.prototype.normalizeTokenKeys=function(e){return e.token&&(e["access-token"]=e.token,delete e.token),e.auth_token&&(e["access-token"]=e.auth_token,delete e.auth_token),e.client_id&&(e.client=e.client_id,delete e.client_id),e.config&&(this.persistData(o,e.config,e.config),delete e.config),e},E.prototype.processSearchParams=function(){var e=this.getQs(),t=null;if(e=this.normalizeTokenKeys(e),e["access-token"]&&e.uid){t=this.buildAuthHeaders(e),this.persistData(n,t),e.reset_password&&this.persistData(m,!0),e.account_confirmation_success&&this.persistData(l,!0);var r=this.getLocationWithoutParams(["access-token","token","auth_token","config","client","client_id","expiry","uid","reset_password","account_confirmation_success"]);this.willRedirect=!0,this.setLocation(r)}return t},E.prototype.getLocationWithoutParams=function(t){var r=e.param(this.stripKeys(this.getSearchQs(),t)),s=e.param(this.stripKeys(this.getAnchorQs(),t)),c=a.location.hash.split("?")[0];return r&&(r="?"+r),s&&(c+="?"+s),c&&!c.match(/^#/)&&(c="#/"+c),a.location.protocol+"//"+a.location.host+a.location.pathname+r+c},E.prototype.stripKeys=function(e,t){for(var r in t)delete e[t[r]];return e},E.prototype.broadcastEvent=function(e,t){r.publish&&r.publish(e,t)},E.prototype.resolvePromise=function(t,r,a){var s=this,c=e.Deferred();return setTimeout(function(){s.broadcastEvent(t,a),r.resolve(a),c.resolve()},0),c.promise()},E.prototype.rejectPromise=function(t,r,a,s){var c=this;return a=e.parseJSON(a&&a.responseText||"{}"),setTimeout(function(){c.broadcastEvent(t,a),r.reject({reason:s,data:a})},0),r},E.prototype.validateToken=function(t){if(t||(t={}),t.config||(t.config=this.getCurrentConfigName()),this.configDfd)return this.configDfd;var r=e.Deferred();if(this.retrieveData(n)){var a=this.getConfig(t.config),s=this.getApiUrl()+a.tokenValidationPath;e.ajax({url:s,context:this,success:function(e){var t=a.handleTokenValidationResponse(e);this.setCurrentUser(t),this.retrieveData(l)&&(this.broadcastEvent("auth.emailConfirmation.success",e),this.persistData(l,!1),this.firstTimeLogin=!0),this.retrieveData(m)&&(this.broadcastEvent("auth.passwordResetConfirm.success",e),this.persistData(m,!1),this.mustResetPassword=!0),this.resolvePromise(u,r,this.user)},error:function(e){this.invalidateTokens(),this.retrieveData(l)&&(this.broadcastEvent("auth.emailConfirmation.error",e),this.persistData(l,!1)),this.retrieveData(m)&&(this.broadcastEvent("auth.passwordResetConfirm.error",e),this.persistData(m,!1)),this.rejectPromise(i,r,e,"Cannot validate token; token rejected by server.")}})}else this.invalidateTokens(),this.rejectPromise(i,r,{},"Cannot validate token; no token found.");return r.promise()},E.prototype.emailSignUp=function(t){t||(t={});var r=this.getConfig(t.config),a=this.getApiUrl()+r.emailRegistrationPath,s=e.Deferred();return t.config_name=t.config,delete t.config,t.confirm_success_url=r.confirmationSuccessUrl(),e.ajax({url:a,context:this,method:"POST",data:t,success:function(e){this.resolvePromise("auth.emailRegistration.success",s,e)},error:function(e){this.rejectPromise("auth.emailRegistration.error",s,e,"Failed to submit email registration.")}}),s.promise()},E.prototype.emailSignIn=function(t){t||(t={});var r=this.getConfig(t.config),a=this.getApiUrl()+r.emailSignInPath,s=e.Deferred();return delete t.config,e.ajax({url:a,context:this,method:"POST",data:t,success:function(e){var t=r.handleLoginResponse(e);this.setCurrentUser(t),this.resolvePromise("auth.emailSignIn.success",s,e),this.broadcastEvent(R,t),this.broadcastEvent(u,this.user)},error:function(e){this.rejectPromise("auth.emailSignIn.error",s,e,"Invalid credentials."),this.broadcastEvent(d,e)}}),s.promise()},E.prototype.listenForCredentials=function(e){var t=this;e.closed?t.rejectPromise(p,t.oAuthDfd,null,"OAuth window was closed bofore registration was completed."):(e.postMessage("requestCredentials","*"),t.oAuthTimer=setTimeout(function(){t.listenForCredentials(e)},500))},E.prototype.openAuthWindow=function(e){if(this.getConfig().forceHardRedirect||a.isIE())this.setLocation(e);else{var t=this.createPopup(e);this.listenForCredentials(t)}},E.prototype.buildOAuthUrl=function(e,t,r){var s=this.getConfig().apiUrl+r+"?auth_origin_url="+encodeURIComponent(a.location.href)+"&config_name="+encodeURIComponent(e||this.getCurrentConfigName())+"&omniauth_window_type=newWindow";if(t)for(var c in t)s+="&",s+=encodeURIComponent(c),s+="=",s+=encodeURIComponent(t[c]);return s},E.prototype.oAuthSignIn=function(t){if(t||(t={}),!t.provider)throw"jToker: provider param undefined for `oAuthSignIn` method.";var r=this.getConfig(t.config),a=r.authProviderPaths[t.provider],s=this.buildOAuthUrl(t.config,t.params,a);if(!a)throw"jToker: providerPath not found for provider: "+t.provider;return this.oAuthDfd=e.Deferred(),this.openAuthWindow(s),this.oAuthDfd.promise()},E.prototype.signOut=function(t){t||(t={});var r=this.getConfig(t.config),a=this.getApiUrl()+r.signOutPath,s=e.Deferred();return e.ajax({url:a,context:this,method:"DELETE",success:function(e){this.resolvePromise("auth.signOut.success",s,e)},error:function(e){this.rejectPromise("auth.signOut.error",s,e,"Failed to sign out.")},complete:function(){this.invalidateTokens()}}),s.promise()},E.prototype.updateAccount=function(t){t||(t={});var r=this.getConfig(t.config),a=this.getApiUrl()+r.accountUpdatePath,s=e.Deferred();return delete t.config,e.ajax({url:a,context:this,method:"PUT",data:t,success:function(e){var t=r.handleAccountUpdateResponse(e);this.setCurrentUser(t),this.resolvePromise("auth.accountUpdate.success",s,e)},error:function(e){this.rejectPromise("auth.accountUpdate.error",s,e,"Failed to update user account")}}),s.promise()},E.prototype.destroyAccount=function(t){t||(t={});var r=this.getConfig(t.config),a=this.getApiUrl()+r.accountDeletePath,s=e.Deferred();return e.ajax({url:a,context:this,method:"DELETE",success:function(e){this.invalidateTokens(),this.resolvePromise("auth.destroyAccount.success",s,e)},error:function(e){this.rejectPromise("auth.destroyAccount.error",s,e,"Failed to destroy user account")}}),s.promise()},E.prototype.requestPasswordReset=function(t){if(t||(t={}),void 0===t.email)throw"jToker: email param undefined for `requestPasswordReset` method.";var r=this.getConfig(t.config),a=this.getApiUrl()+r.passwordResetPath,s=e.Deferred();return t.config_name=t.config,delete t.config,t.redirect_url=r.passwordResetSuccessUrl(),e.ajax({url:a,context:this,method:"POST",data:t,success:function(e){this.resolvePromise("auth.passwordResetRequest.success",s,e)},error:function(e){this.rejectPromise("auth.passwordResetRequest.error",s,e,"Failed to submit email registration.")}}),s.promise()},E.prototype.updatePassword=function(t){t||(t={});var r=this.getConfig(t.config),a=this.getApiUrl()+r.passwordUpdatePath,s=e.Deferred();return delete t.config,e.ajax({url:a,context:this,method:"PUT",data:t,success:function(e){this.resolvePromise("auth.passwordUpdate.success",s,e)},error:function(e){this.rejectPromise("auth.passwordUpdate.error",s,e,"Failed to update password.")}}),s.promise()},E.prototype.persistData=function(t,r,s){switch(r=JSON.stringify(r),this.getConfig(s).storage){case"localStorage":a.localStorage.setItem(t,r);break;default:e.cookie(t,r,{expires:this.getConfig(s).cookieExpiry,path:this.getConfig(s).cookiePath})}},E.prototype.retrieveData=function(t){var r=null;switch(this.getConfig().storage){case"localStorage":r=a.localStorage.getItem(t);break;default:r=e.cookie(t)}try{return e.parseJSON(r)}catch(e){return g(r)}},E.prototype.getCurrentConfigName=function(){var t=null;return this.getQs().config&&(t=this.getQs().config),e.cookie&&!t&&(t=e.cookie(o)),a.localStorage&&!t&&(t=a.localStorage.getItem(o)),t=t||this.defaultConfigKey||c,g(t)},E.prototype.deleteData=function(t){switch(this.getConfig().storage){case"cookies":e.removeCookie(t,{path:this.getConfig().cookiePath});break;default:a.localStorage.removeItem(t)}},E.prototype.getConfig=function(e){if(!this.configured)throw"jToker: `configure` must be run before using this plugin.";return e=e||this.getCurrentConfigName(),this.configs[e]},E.prototype.appendAuthHeaders=function(e,t){var r=a.auth.retrieveData(n);if(x(t.url)&&r){e.setRequestHeader("If-Modified-Since","Mon, 26 Jul 1997 05:00:00 GMT");for(var s in a.auth.getConfig().tokenFormat)e.setRequestHeader(s,r[s])}},E.prototype.updateAuthCredentials=function(e,t,r){if(x(r.url)){var s={},c=!0;for(var o in a.auth.getConfig().tokenFormat)s[o]=t.getResponseHeader(o),s[o]&&(c=!1);c||a.auth.persistData(n,s)}},E.prototype.getRawSearch=function(){return a.location.search},E.prototype.getRawAnchor=function(){return a.location.hash},E.prototype.setRawAnchor=function(e){a.location.hash=e},E.prototype.getAnchorSearch=function(){var e=this.getRawAnchor().split("?");return e.length>1?e[1]:null},E.prototype.setRawSearch=function(e){a.location.search=e},E.prototype.setSearchQs=function(t){return this.setRawSearch(e.param(t)),this.getSearchQs()},E.prototype.setAnchorQs=function(t){return this.setAnchorSearch(e.param(t)),this.getAnchorQs()},E.prototype.setLocation=function(e){a.location.replace(e)},E.prototype.createPopup=function(e){return a.open(e)},E.prototype.getSearchQs=function(){var e=this.getRawSearch().replace("?","");return e?t(e):{}},E.prototype.getAnchorQs=function(){var e=this.getAnchorSearch();return e?t(e):{}},E.prototype.getQs=function(){return e.extend(this.getSearchQs(),this.getAnchorQs())};var h=function(e){for(var t in e)return t},g=function(e){return e&&e.replace(/("|')/g,"")},x=function(e){return e.match(a.auth.getApiUrl())},f=function(e,t){for(var r=function(e,r){return void 0===t[r]?e:t[r]},a=new RegExp("{{\\s*([a-z0-9-_]+)\\s*}}","ig"),s="";s!==e;e=(s=e).replace(a,r));return e};return a.isOldIE=function(){var e=!1,t=s.userAgent.toLowerCase();if(t&&-1!==t.indexOf("msie")){parseInt(t.split("msie")[1])<10&&(e=!0)}return e},a.isIE=function(){var e=a.isOldIE(),t=!!s.userAgent.match(/Trident.*rv\:11\./);return e||t},a.auth=e.auth=new E,a.auth});